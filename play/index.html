<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<title>Play | Top Hat Rider</title>
	<link rel="stylesheet" href="/game/assets/styles/default.css">
	<link rel="stylesheet" href="/game/assets/styles/dark.css" id="game-theme">
	<link rel="stylesheet" href="/game/assets/styles/gui.css">
	<script src="/game/assets/scripts/elements/GameInstance.js"></script>
	<script src="/game/assets/scripts/elements/SmartLabel.js"></script>
</head>
<body>
	<bhr-instance class="vignette" id="game-container" playing>
		<canvas id="main" part="main"></canvas>
		<div class="gui">
			<div class="toolbar scale">
				<!-- <section class="bottom island right">
					<button class="toolbar-item fullscreen" title="Fullscreen - F" onclick="document.fullscreenElement ? document.exitFullscreen() : game.container.requestFullscreen()"></button>
				</section> -->
				<section class="bottom center island">
					<button class="toolbar-item rewind" title="Cancel Checkpoint - Backspace" onclick="game.scene.removeCheckpoint()"></button>
					<button class="toolbar-item backtrack" title="Checkpoint - Enter" onclick="game.scene.returnToCheckpoint()"></button>
					<label class="toolbar-item playpause" tooltip="Pause/Play" kbd="Space"><input type="checkbox" checked hidden onchange="game.scene.paused=!this.checked"></label><!-- ‚ñ∂ -->
					<button class="toolbar-item backtrack" title="Checkpoint - Shift + Enter" style="rotate: 180deg;" onclick="game.scene.returnToCheckpoint()"></button>
					<button class="toolbar-item rewind" title="Cancel Checkpoint - Shift + Backspace" style="rotate: 180deg;" onclick="game.scene.restoreCheckpoint()"></button>
				</section>
				<section class="center island top" id="recorder" style="display: none;">
					<!-- Display recording time -->
					<button id="toggle" title="Stop recording - Ctrl + Shift + R" onclick="game.mediaRecorder.addEventListener('stop', event => (this.parentElement.style.setProperty('display', 'none'), document.querySelector('#game-overlay').checked = true));game.mediaRecorder.stop()">Stop recording</button>
					<!-- <button class="toolbar-item recordstop" title="(Start/Stop??) Record - Ctrl + R" onclick="game.scene.removeCheckpoint()">üî¥</button>
					<button class="toolbar-item" title="Stop recording - Backspace" onclick="game.scene.removeCheckpoint()">‚óæ</button>‚óº /‚óæ -->
				</section>
				<section class="island left middle" id="toolbar">
					<button class="toolbar-item change-vehicle" tooltip="Change Vehicle" kbd="Ctrl+b" onclick="game.scene.switchBike()">
						<svg viewBox="0 0 25 25" stroke="#777">
							<circle cx="12.5" cy="12.5" r="10" fill="none" stroke="currentColor" stroke-width="2.5" />
							<path d="M12.5 12.5L20.5 12.5
								M12.5 12.5L19.43 16.5
								M12.5 12.5L16.5 19.43
								M12.5 12.5L12.5 20.5
								M12.5 12.5L8.5 19.43
								M12.5 12.5L5.57 16.5
								M12.5 12.5L4.5 12.5
								M12.5 12.5L5.57 8.5
								M12.5 12.5L8.5 5.57
								M12.5 12.5L12.5 4.5
								M12.5 12.5L16.5 5.57
								M12.5 12.5L19.43 8.5" />
						</svg>
					</button>
					<button class="toolbar-item" tooltip="Camera" kbd="r" data-tool="camera" data-options="tool-settings" onclick="game.scene.toolHandler.setTool(this.dataset.tool)">
						<input type="radio" name="tool" hidden>
						<svg xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" viewBox="0 0 16 16">
							<circle cx="8" cy="8" r="5" fill="none"/>
							<path d="M6.5 3 8 1l1.5 2m-3 10L8 15l1.5-2M3 6.5 1 8l2 1.5m10-3L15 8l-2 1.5" stroke-linecap="round" stroke-linejoin="round"/>
						</svg>
					</button>
				</section>
				<section class="island middle right tool-options" id="tool-options">
					<div id="line-style" style="display:none">
						<label class="toolbar-item" tooltip="Physics" onchange="game.scene.toolHandler.setTool(game.scene.toolHandler.selected, false)"><input type="radio" name="style" checked hidden>‚óè</label>
						<label class="toolbar-item scenery" tooltip="Scenery" onchange="game.scene.toolHandler.setTool(game.scene.toolHandler.selected, true)"><input type="radio" name="style" hidden>‚óè</label>
					</div>
					<div id="tool-settings" style="display:none">
						<button class="toolbar-item increment" tooltip="Increase length" kbd="a+scroll" onclick="game.scene.toolHandler.currentTool.scroll({ wheelDelta: 1 });">
							<svg xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 16 16">
								<line x1="1" x2="15" y1="8" y2="8"/>
								<line x1="8" x2="8" y1="1" y2="15"/>
							</svg>
						</button>
						<button class="toolbar-item decrement" tooltip="Decrease length" kbd="a+Scroll" onclick="game.scene.toolHandler.currentTool.scroll({ wheelDelta: -1 });">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
								<line x1="1" x2="15" y1="8" y2="8" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
							</svg>
						</button>
					</div>
					<button class="toolbar-item pip" tooltip="Picture in picture" onclick="game.togglePictureInPicture()">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linejoin="round" viewBox="0 0 16 16">
							<path d="M15 2.5H1V13.5H15Z" opacity=".85" stroke-width="2"/>
							<path d="M12.5 7.5H7.5V11H12.5Z" stroke-width="1.5"/>
						</svg>
					</button>
					<button class="toolbar-item fullscreen" tooltip="Fullscreen" kbd="f" onclick="document.fullscreenElement ? document.exitFullscreen() : game.container.requestFullscreen()">
						<!-- <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
							<path d="M4.5 1H1V4.5M1 1L6 6M10 10L15 15M15 11.5V15H11.5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
						</svg> -->
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
							<path d="M15 6.5V1H9.5M6.5 1H1V6.5M1 9.5V15H6.5M9.5 15H15V9.5" fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="2"/>
						</svg>
					</button>
				</section>
				<!-- <input type="range" class="bottom timebar" style="left: 0;margin: 0;position: absolute;right: 0;"> -->
			</div>
			<progress class="replay-progress" max="100" min="0" value="40" style="display: none;"></progress>
		</div>
		<div class="overlay">
			<input type="checkbox" id="game-overlay" hidden>
			<nav>
				<label class="ripple" for="replay">Replay</label>
				<label class="ripple" for="controls">Controls</label>
				<label class="ripple" for="recorder-toggle">Recorder</label>
				<label class="ripple" for="settings">Settings</label>
			</nav>
			<section>
				<input type="radio" name="game-overlay-nav" id="replay" checked hidden>
				<!-- Display races (game.scene.races/game.scene.players/game.scene.ghosts) -->
				<button disabled onclick="game.scene.ghosts.splice(0);" style="background-color: hsl(0deg 40% 40% / calc(50% + 10% * var(--brightness-multiplier)));">Clear</button>
				<button onclick="gcode.nextElementSibling.lastElementChild.style.setProperty('display', 'none');gcode.nextElementSibling.lastElementChild.previousElementSibling.style.removeProperty('display');ghostdialog.showModal();">Load</button>
				<button onclick="
					Object.assign(document.createElement('input'), {
						accept: 'text/plain',
						type: 'file',
						onchange: async event => {
							for (const file of event.target.files) {
								game.scene.watchGhost(await file.text());
							}
						}
					}).click();
				">Load File...</button>
				<button onclick="gcode.value = game.scene.firstPlayer.records.map(record => Array.from(record).join(' ')).join(',') + ',' + game.scene.currentTime + ',' + game.scene.firstPlayer.vehicle.name;gcode.nextElementSibling.lastElementChild.style.removeProperty('display');gcode.nextElementSibling.lastElementChild.previousElementSibling.style.setProperty('display', 'none');ghostdialog.showModal();">Save</button>
				<button onclick="
					Object.assign(document.createElement('a'), {
						download: 'bhr_ghost-' + new Intl.DateTimeFormat(navigator.language, { dateStyle: 'short', timeStyle: 'medium' }).format().replace(/[/:]/g, '-').replace(/,+\s*/, '_').replace(/\s+.*$/, ''),
						href: window.URL.createObjectURL(new Blob([gcode.value], { type: 'text/plain' }))
					}).click();
				">Save As...</button>
				<dialog id="ghostdialog" onclose="event.target.returnValue == 'default' && (game.scene.watchGhost(gcode.value),document.querySelector('#game-overlay').checked = false),gcode.value = null">
					<h2>Load replay</h2>
					<form method="dialog" style="margin: 0;">
						<textarea placeholder="Ghost data" cols="30" rows="7" id="gcode" onkeydown="event.stopPropagation()" onkeyup="event.stopPropagation()"></textarea>
						<div style="display: flex;gap: .25rem;margin-top: .25rem;">
							<button value="cancel" style="width: -webkit-fill-available;">Cancel</button>
							<button value="default" class="hidden-placeholder" style="width: -webkit-fill-available;">Load</button>
							<button value="download" class="hidden-placeholder" onclick="
								Object.assign(document.createElement('a'), {
									download: 'bhr_ghost-' + new Intl.DateTimeFormat(navigator.language, { dateStyle: 'short', timeStyle: 'medium' }).format().replace(/[/:]/g, '-').replace(/,+\s*/, '_').replace(/\s+.*$/, ''),
									href: window.URL.createObjectURL(new Blob([gcode.value], { type: 'text/plain' }))
								}).click();
							" style="display: none;width: -webkit-fill-available;">Save As...</button>
						</div>
					</form>
				</dialog>
			</section>
			<section>
				<input type="radio" name="game-overlay-nav" id="controls" hidden>
				<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/kbd -->
			</section>
			<section>
				<input type="radio" name="game-overlay-nav" id="recorder-toggle" hidden>
				<button style="width: -webkit-fill-available;" onclick="game.createRecorder(blobURL => (download.href = blobURL) && loadrecording.showModal()).start(),recorder.style.removeProperty('display'),document.querySelector('#game-overlay').checked = false" onkeydown="event.stopPropagation()" onkeyup="event.stopPropagation()">Start Recorder</button>
				<label>FPS&emsp;<input type="number" min="10" max="300" step="10" value="50"></label>
				<button style="width: -webkit-fill-available;" disabled><a download="bhr_recording" id="adownload">Download</a></button>
				<dialog id="loadrecording">
					<form method="dialog" style="margin: 0;">
						<button style="width: -webkit-fill-available;"><a download="bhr_recording" id="download">Download</a></button>
						<div style="display: flex;gap: .25rem;margin-top: .25rem;">
							<button value="cancel" style="width: -webkit-fill-available;">Close</button>
						</div>
					</form>
				</dialog>
			</section>
			<section style="gap: 1rem;">
				<input type="radio" name="game-overlay-nav" id="settings" hidden>
				<section title="Editor">
					<label dependant="next-element">Auto save<input type="checkbox" id="auto-save" onchange="game.settings.autoSave = event.target.checked;"></label>
					<label dependency="previous-element">Interval<input type="number" id="auto-save-interval" min="5" value="5" max="60" style="box-sizing: content-box;max-width: 2rem;" onchange="game.settings.autoSaveInterval = event.target.value;"></label>
					<label class="disabled">Continue where you left off<input type="checkbox" id="game-settings.restore-previous-session" onchange="game.settings.restorePreviousSession = event.target.checked;" disabled=""></label>
				</section>
				<section title="Game">
					<label>Auto pause<input type="checkbox" id="auto-pause" onchange="game.settings.autoPause = event.target.checked"></label>
					<label class="disabled">Linear Interpolation<input type="checkbox" id="game-settings.interpolation" checked disabled onchange="game.settings.interpolation = event.target.checked"></label>
					<label dependant="next-element">Limit FPS<input type="checkbox" id="limit-fps" onchange="game.settings.limitFPS = event.target.checked"></label>
					<label dependency="previous-element">FPS<input type="number" id="fps" min="0" value="60" style="box-sizing: content-box;max-width: 2.5rem;" onchange="game.settings.fps = event.target.value;"></label>
					<label>Hide HUD<input type="checkbox" id="hide-hud" onchange="game.settings.hideHUD = event.target.checked"></label>
				</section>
				<section title="Appearance">
					<label>System<input type="radio" name="color-scheme" id="system" onchange="game.settings.theme = event.target.id" checked></label>
					<label class="disabled">Auto<input type="radio" name="color-scheme" id="auto" disabled onchange="game.settings.theme = event.target.id"></label>
					<label>Dark<input type="radio" name="color-scheme" id="dark" onchange="game.settings.theme = event.target.id"></label>
					<label>Light<input type="radio" name="color-scheme" id="light" onchange="game.settings.theme = event.target.id"></label>
					<label>Midnight<input type="radio" name="color-scheme" id="midnight" onchange="game.settings.theme = event.target.id"></label>
					<label>Custom<input type="radio" name="color-scheme" id="custom" onchange="game.settings.theme = event.target.id"></label>
					<br>
					<label>Brightness<input type="range" id="game-settings.brightness" min="1" value="100" max="100" onchange="game.settings.brightness = event.target.value"></label>
					<label class="disabled">Vignette<input type="checkbox" id="game-settings.vignette" checked disabled onchange="game.settings.vignette = event.target.checked"></label>
				</section>
				<section title="Miscellaneous">
					<label>Discord Rich Presence<input type="checkbox" id="discord-rich-presence" checked onchange="game.settings.discordRichPresence = event.target.checked"></label>
				</section>
				<section title="Debug">
					<label>Display FPS<input type="checkbox" id="display-fps" onchange="game.settings.displayFPS = event.target.checked"></label>
				</section>
			</section>
			<button id="exit" style="margin: 1rem;max-width: 25vmin;" onclick="window.close()">Exit to desktop</button>
		</div>
		<div class="toast-container" id="toasts"></div>
	</bhr-instance>
	<script type="module" src="/game/bootstrap.js"></script>
	<script>
		const gameContainer = document.querySelector('#game-container');

		gameContainer.addEventListener('ready', function({ detail: game }) {
			const searchParams = new URLSearchParams(location.search);
			const trackId = searchParams.get('t');

			const script = document.createElement('script');
			script.addEventListener('load', function() {
				console.debug('Track script loaded');
				this.remove();
			});
			script.src = `https://cdn.freeriderhd.com/free_rider_hd/tracks/prd/${trackId}/track-data-v1.js?callback=t`;
			document.head.appendChild(script);

			Object.defineProperty(window, 'game', { value: game, writable: true });
			Object.defineProperty(window, 't', {
				value(data) {
					console.debug('Track data loaded', data);
					// parse track code, show incompatibility
					// warning if contains powerups/vehicles
					// that don't exist in BHR
					game.init({
						code: data.code,
						id: trackId + '@frhd'
					});
				}
			});
		});
	</script>
</body>
</html>